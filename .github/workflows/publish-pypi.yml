name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # REQUIRED for PyPI trusted publishing
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build
    
    - name: Verify directory structure
      run: |
        echo "ğŸ“ Current directory structure:"
        pwd
        ls -la
        
        echo -e "\nğŸ“ Python directory:"
        ls -la python/
        
        echo -e "\nğŸ“„ Checking required files:"
        [ -f "python/setup.py" ] && echo "âœ… python/setup.py exists" || echo "âŒ python/setup.py missing"
        [ -f "python/README.md" ] && echo "âœ… python/README.md exists" || echo "âŒ python/README.md missing"
        [ -f "python/minecraft_server_utility/__init__.py" ] && echo "âœ… __init__.py exists" || echo "âŒ __init__.py missing"
        
        echo -e "\nğŸ“¦ Package metadata:"
        cd python
        python -c "
try:
    from minecraft_server_utility import __version__
    print(f'âœ… Package version: {__version__}')
except ImportError as e:
    print(f'âŒ Import error: {e}')
        "
    
    - name: Build package
      working-directory: ./python
      run: |
        echo "ğŸ”¨ Building package..."
        python -m build
        
        echo -e "\nğŸ“¦ Build output:"
        ls -la dist/
        echo -e "\nğŸ“„ Package contents:"
        tar -tzf dist/*.tar.gz | head -20
    
    - name: Verify package with twine
      working-directory: ./python
      run: |
        pip install twine
        python -m twine check dist/*
        echo "âœ… Package verification passed"
    
    - name: Publish to PyPI
      if: success()
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: ./python/dist/
    
    - name: Verify publication
      if: success()
      run: |
        echo "â³ Waiting for PyPI to index the package..."
        sleep 30
        
        VERSION=$(cd python && python -c "from minecraft_server_utility import __version__; print(__version__)")
        PACKAGE_NAME="minecraft-server-utility"
        
        echo "ğŸ” Checking if package is on PyPI..."
        echo "Package: $PACKAGE_NAME"
        echo "Version: $VERSION"
        
        # Try to check via PyPI API
        curl -s "https://pypi.org/pypi/$PACKAGE_NAME/$VERSION/json" | \
          jq -r '.info.version + " is available on PyPI!"' 2>/dev/null || \
          echo "âš ï¸  Package might not be indexed yet. Check manually at:"
        echo "ğŸŒ https://pypi.org/project/$PACKAGE_NAME/"
    
    - name: Notify on success
      if: success()
      run: |
        echo "ğŸ‰ Successfully published to PyPI!"
        echo "ğŸ“¦ Package: minecraft-server-utility"
        echo "ğŸ·ï¸  Version: $(cd python && python -c "from minecraft_server_utility import __version__; print(__version__)")"
        echo "ğŸ”— URL: https://pypi.org/project/minecraft-server-utility/"
