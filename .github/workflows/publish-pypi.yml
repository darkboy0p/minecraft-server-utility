name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Manual trigger

jobs:
  build-and-publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    environment: pypi  # Create this environment in GitHub settings
    
    permissions:
      id-token: write  # Important for trusted publishing
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Verify package metadata
      working-directory: ./python
      run: |
        python -c "
import sys
sys.path.insert(0, '.')
from minecraft_server_utility import __version__, __author__
print(f'Package: minecraft-server-utility')
print(f'Version: {__version__}')
print(f'Author: {__author__}')
print('‚úÖ Package metadata verified')
        "
    
    - name: Build package
      working-directory: ./python
      run: |
        python -m build
        echo "üì¶ Built package files:"
        ls -la dist/
    
    - name: Verify package files
      working-directory: ./python
      run: |
        # Check wheel
        echo "üîç Checking wheel file..."
        python -m wheel unpack dist/*.whl --dest unpacked-wheel
        echo "‚úÖ Wheel unpacked successfully"
        
        # Check source distribution
        echo "üîç Checking source distribution..."
        tar -tzf dist/*.tar.gz | head -20
        
        # List package contents
        echo "üìÅ Package contents:"
        tar -tzf dist/*.tar.gz | grep -E "\.py$" | head -10
    
    - name: Check package with twine
      working-directory: ./python
      run: |
        python -m twine check dist/*
    
    - name: Publish to TestPyPI
      if: github.event_name == 'workflow_dispatch'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        packages-dir: ./python/dist/
    
    - name: Publish to PyPI
      if: github.event_name == 'release'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: ./python/dist/
    
    - name: Verify installation from PyPI
      if: success()
      run: |
        # Wait a bit for PyPI to update
        sleep 30
        
        # Create virtual environment for test
        python -m venv test-env
        source test-env/bin/activate
        
        echo "üîç Testing installation from PyPI..."
        
        if [ "${{ github.event_name }}" == "release" ]; then
          # Try to install from actual PyPI
          pip install --upgrade pip
          pip install minecraft-server-utility || echo "‚ö†Ô∏è  Package might not be indexed yet"
        else
          # For TestPyPI
          pip install --upgrade pip
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ minecraft-server-utility || echo "‚ö†Ô∏è  TestPyPI installation test"
        fi
        
        # Test import
        python -c "
try:
    import minecraft_server_utility
    print('‚úÖ Import successful')
    print(f'Version: {minecraft_server_utility.__version__}')
except ImportError as e:
    print(f'‚ùå Import failed: {e}')
        "
    
    - name: Notify Discord on success
      if: success()
      uses: appleboy/discord-action@master
      with:
        webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
        webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
        username: 'PyPI Publisher'
        message: |
          üéâ **New PyPI Release Published!**
          **Package:** minecraft-server-utility
          **Version:** ${{ github.ref_name }}
          **Link:** https://pypi.org/project/minecraft-server-utility/
          **Release:** ${{ github.event.release.html_url }}
    
    - name: Notify on failure
      if: failure()
      uses: appleboy/discord-action@master
      with:
        webhook_id: ${{ secrets.DISCORD_WEBHOOK_ID }}
        webhook_token: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
        username: 'PyPI Publisher'
        message: |
          ‚ùå **PyPI Publication Failed!**
          **Package:** minecraft-server-utility
          **Version:** ${{ github.ref_name }}
          **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
