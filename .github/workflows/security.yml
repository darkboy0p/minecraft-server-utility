name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Python Security Scan
      working-directory: ./python
      run: |
        echo "üîç Checking Python dependencies for security vulnerabilities..."
        # Install safety if not present
        pip install safety
        
        # Check for vulnerabilities
        if [ -f "requirements.txt" ]; then
          safety check -r requirements.txt --output text || true
        else
          echo "‚ö†Ô∏è  requirements.txt not found"
        fi
    
    - name: Install Java Dependency-Check
      working-directory: ./java
      run: |
        echo "üì¶ Installing OWASP Dependency-Check..."
        # Download and install dependency-check
        wget -q -O dependency-check.zip https://github.com/jeremylong/DependencyCheck/releases/download/v8.3.1/dependency-check-8.3.1-release.zip
        unzip -q dependency-check.zip
        rm dependency-check.zip
        
        # Create reports directory
        mkdir -p reports
    
    - name: Run Java Dependency Check
      working-directory: ./java
      run: |
        echo "üîç Scanning Java dependencies..."
        ./dependency-check/bin/dependency-check.sh \
          --project "minecraft-server-utility" \
          --scan "." \
          --out "./reports" \
          --format "HTML" \
          --format "JSON" \
          --failOnCVSS 9 \
          --enableExperimental || true
        
        echo "‚úÖ Dependency check completed"
    
    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports-${{ github.sha }}
        path: |
          java/reports/
        retention-days: 7

  snyk-security:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the workflow if Snyk fails
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Run Snyk for Python
      if: ${{ secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/python@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --fail-on=upgradable
      continue-on-error: true
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Run Snyk for Java
      if: ${{ secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/maven@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --fail-on=upgradable
      continue-on-error: true
    
    - name: Snyk Monitor
      if: ${{ secrets.SNYK_TOKEN != '' }}
      uses: snyk/actions/maven@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        command: monitor
      continue-on-error: true
