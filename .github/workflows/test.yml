name: Automated Tests

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        cd python
        pip install -e .
        pip install pytest pytest-mock pytest-asyncio requests
    
    - name: Run unit tests
      run: |
        cd python
        pytest tests/test_python.py -v
    
    - name: Run integration tests
      run: |
        cd python
        python -m pytest tests/ -k "integration" -v --tb=short

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Run example scripts
      run: |
        cd python
        pip install -e .
        
        # Test basic examples
        python examples/basic_usage.py --test
        
        # Test player lookup (mock mode)
        python examples/player_lookup.py --test
    
    - name: Test with real servers (limited)
      continue-on-error: true
      run: |
        cd python
        python -c "
        from minecraft_server_utility import ServerPinger
        import time
        
        # Test with timeout to avoid hanging
        print('Testing server connectivity...')
        servers = [
            ('mc.hypixel.net', 25565),
            ('us.mineplex.com', 25565)
        ]
        
        for host, port in servers:
            try:
                pinger = ServerPinger(host, port, timeout=3)
                online = pinger.is_online()
                print(f'{host}:{port} - Online: {online}')
            except Exception as e:
                print(f'{host}:{port} - Error: {e}')
            time.sleep(1)
        "

  benchmark:
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Run benchmarks
      run: |
        cd python
        pip install -e .
        
        echo "Running performance benchmarks..."
        python -c "
        import time
        from minecraft_server_utility import ServerPinger
        
        # Benchmark ping performance
        pinger = ServerPinger('localhost', 25565, timeout=2)
        
        times = []
        for i in range(5):
            start = time.time()
            try:
                pinger.is_online()
            except:
                pass
            elapsed = (time.time() - start) * 1000
            times.append(elapsed)
            print(f'Ping {i+1}: {elapsed:.2f}ms')
        
        if times:
            avg = sum(times) / len(times)
            print(f'Average ping time: {avg:.2f}ms')
        "
